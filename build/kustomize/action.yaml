name: Kustomize Build
author: Eviive
description: Builds Kubernetes manifests using Kustomize

inputs:
  working-directory:
    description: The working directory to run Kustomize in
    default: .
  kustomize-version:
    description: The Kustomize version to build with
  helm-version:
    description: The Helm version to build with if needed

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Kustomize
      uses: eviive/actions/setup/kustomize@main
      with:
        version: ${{ inputs.kustomize-version }}

    - id: check-helm
      name: Check if Helm is needed
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        if grep -q "helmCharts:" kustomization.yaml; then
          echo "need-helm=true" >> $GITHUB_OUTPUT
          echo "helm-args=--enable-helm --load-restrictor LoadRestrictionsNone" >> $GITHUB_OUTPUT
        else
          echo "need-helm=false" >> $GITHUB_OUTPUT
          echo "helm-args=" >> $GITHUB_OUTPUT
        fi

    - name: Setup Helm
      if: ${{ steps.check-helm.outputs.need-helm == 'true' }}
      uses: eviive/actions/setup/helm@main
      with:
        version: ${{ inputs.helm-version }}

    - name: Build Kustomize
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: kustomize build ${{ steps.check-helm.outputs.helm-args }} .
